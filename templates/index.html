<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8">
    <title>LassSup Web</title>
    <!-- Domyślny motyw ciemny (Darkly) -->
    <link id="themeStylesheet" rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/darkly/bootstrap.min.css">
    <!-- Własne style -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
    <!-- Plugin colResizable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>
  </head>
  <body>
    <!-- Nagłówek strony – dodaliśmy przycisk do rozwijania sidebaru po lewej -->
    <header class="card-header top-bar">
      <div class="d-flex justify-content-between align-items-center w-100">
        <div class="d-flex align-items-center">
          <button id="sidebarToggle" class="btn btn-primary sidebar-toggle-btn">〉</button>
          <div class="logo" style="margin-left:10px;">
            <h5 class="mb-0">LassSup Web</h5>
          </div>
        </div>
        <div>
          <button id="themeToggle" class="btn btn-secondary theme-toggle-btn">
            <span id="themeIcon">☀</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Ukryty input pliku -->
    <input type="file" id="fileInput" name="file" accept=".html, .pdf">

    <!-- Sidebar – rozwijalny panel z lewej -->
    <div id="sidebar">
      <div class="sidebar-content">
        <form id="pricingForm">
          <div class="form-group">
            <label for="cuttingCostBlack">Koszt cięcia stali czarnej</label>
            <input type="number" class="form-control" id="cuttingCostBlack" value="10.00">
          </div>
          <div class="form-group">
            <label for="cuttingCostStainless">Koszt cięcia stali nierdzewnej</label>
            <input type="number" class="form-control" id="cuttingCostStainless" value="15.00">
          </div>
          <div class="form-group">
            <label for="cuttingCostAluminium">Koszt cięcia aluminium</label>
            <input type="number" class="form-control" id="cuttingCostAluminium" value="20.00">
          </div>
          <div class="form-group">
            <label for="materialCostBlack">Koszt materiału (stal czarna)</label>
            <input type="number" class="form-control" id="materialCostBlack" value="5.00">
          </div>
          <div class="form-group">
            <label for="materialCostStainless">Koszt materiału (stal nierdzewna)</label>
            <input type="number" class="form-control" id="materialCostStainless" value="8.00">
          </div>
          <div class="form-group">
            <label for="materialCostAluminium">Koszt materiału (aluminium)</label>
            <input type="number" class="form-control" id="materialCostAluminium" value="12.00">
          </div>
          <div class="form-group">
            <label for="bendingCostSum">Suma kosztów gięcia</label>
            <input type="number" class="form-control" id="bendingCostSum" value="30.00">
          </div>
        </form>
      </div>
    </div>

    <!-- Główna zawartość – margines-left zależy od stanu sidebaru -->
    <div class="container-fluid main-container">
      <!-- Karty "Dane programów:" i "Wycena:" -->
      <div class="row header-spacing mb-3">
        <!-- Karta "Dane programów:" -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="header-text">Dane programów:</span>
              <button id="plusButton" class="btn btn-success plus-btn">
                <span style="font-size:1.5em;">&#43;</span>
              </button>
            </div>
            <div class="card-body fixed-height">
              <div class="table-responsive fixed-window">
                <table id="programsTable" class="table table-bordered sticky-table">
                  <colgroup>
                    <col style="width:5%;">
                    <col style="width:25%;">
                    <col style="width:20%;">
                    <col style="width:15%;">
                    <col style="width:20%;">
                    <col style="width:15%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th></th>
                      <th>Nazwa programu</th>
                      <th>Materiał</th>
                      <th>Grubość</th>
                      <th>Czas programu</th>
                      <th>Ilość powtórzeń</th>
                    </tr>
                  </thead>
                  <tbody id="programsTableBody">
                    <!-- Wiersze programów dodawane dynamicznie -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Karta "Wycena:" -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">Wycena:</div>
            <div class="card-body fixed-height">
              <p>Brak danych</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Karta "Detale:" -->
      <div class="row flex-grow-1">
        <div class="col">
          <div class="card h-100">
            <div class="card-header">Detale:</div>
            <div class="card-body fixed-height">
              <div class="table-responsive fixed-window">
                <table id="detailsTable" class="table table-bordered sticky-table">
                  <colgroup>
                    <col style="width:2%;">
                    <col style="width:10%;">
                    <col style="width:15%;">
                    <col style="width:10%;">
                    <col style="width:10%;">
                    <col style="width:10%;">
                    <col style="width:10%;"> <!-- Wymiar Y -->
                    <col style="width:10%;"> <!-- Nowa kolumna: Ilość gięć -->
                    <col style="width:10%;"> <!-- Czas cięcia -->
                    <col style="width:10%;">
                    <col style="width:10%;">
                    <col style="width:10%;">
                    <col style="width:10%;">
                    <col style="width:10%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th></th>
                      <th>Rysunek</th>
                      <th>Nazwa detalu</th>
                      <th>Materiał</th>
                      <th>Grubość</th>
                      <th>Wymiar X</th>
                      <th>Wymiar Y</th>
                      <th>Ilość gięć</th>
                      <th>Czas cięcia</th>
                      <th>Ilość</th>
                      <th>Koszt cięcia</th>
                      <th>Koszt materiału</th>
                      <th>Koszt detalu</th>
                      <th>Całkowity koszt</th>
                    </tr>
                  </thead>
                  <tbody id="detailsTableBody">
                    <!-- Wiersze detali dodawane dynamicznie -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Wskaźnik ładowania -->
      <div id="loading" class="row">
        <div class="col">
          <div class="spinner-border" role="status">
            <span class="sr-only">Ładowanie...</span>
          </div>
          <span>Przetwarzanie pliku, proszę czekać...</span>
        </div>
      </div>
    </div>

    <script>
      // Toggle sidebar – przycisk umieszczony w top-bar
      $(document).ready(function(){
        $("#sidebarToggle").click(function(){
          $("#sidebar").toggleClass("expanded");
          if ($("#sidebar").hasClass("expanded")) {
            $(".main-container").removeClass("collapsed").addClass("expanded");
            $(this).text("〈");
          } else {
            $(".main-container").removeClass("expanded").addClass("collapsed");
            $(this).text("〉");
          }
        });
      });

      function generateProgramId() {
        return 'program_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
      }
      function formatSecondsToHMS(seconds) {
        var h = Math.floor(seconds / 3600);
        var m = Math.floor((seconds % 3600) / 60);
        var s = seconds % 60;
        return (h < 10 ? "0" + h : h) + ":" +
               (m < 10 ? "0" + m : m) + ":" +
               (s < 10 ? "0" + s : s);
      }
      $(document).ready(function() {
        $("#loading").hide();
        $("#plusButton").click(function() {
          $("#fileInput").click();
        });
        $("#themeToggle").click(function(){
          var darkTheme = $("#themeToggle").data("darkTheme");
          if(darkTheme === undefined) darkTheme = true;
          if(darkTheme) {
            $("#themeStylesheet").attr("href", "https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/flatly/bootstrap.min.css");
            $("#themeIcon").text("☾");
            $("#themeToggle").data("darkTheme", false);
            $("body").addClass("light-theme");  // Dodajemy klasę dla jasnego motywu
          } else {
            $("#themeStylesheet").attr("href", "https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/darkly/bootstrap.min.css");
            $("#themeIcon").text("☀");
            $("#themeToggle").data("darkTheme", true);
            $("body").removeClass("light-theme");  // Usuwamy klasę przy powrocie do ciemnego motywu
          }
        });

        $("#fileInput").change(function(){
          var fileName = $(this).val().split("\\").pop();
          var programId = generateProgramId();
          $("#loading").show();
          var file = $(this)[0].files[0];
          if (!file) return;
          var formData = new FormData();
          formData.append("file", file);
          $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
              $("#loading").hide();
              var programsTbody = $("#programsTableBody");
              var progRow = "<tr data-program-id='" + programId + "'>";
              progRow += "<td><button class='btn btn-danger btn-sm remove-program' data-program-id='" + programId + "'>-</button></td>";
              progRow += "<td>" + (response.name || "") + "</td>";
              progRow += "<td>" + (response.material || "") + "</td>";
              progRow += "<td>" + (response.thicknes || "") + "</td>";
              progRow += "<td>" + (response.machine_time || "") + "</td>";
              progRow += "<td>" + (response.program_counts || "") + "</td>";
              progRow += "</tr>";
              programsTbody.append(progRow);
              var detailsTbody = $("#detailsTableBody");
              // W success callback, przy generowaniu wiersza detalu:
              response.details.forEach(function(detail) {
                // Upewnij się, że obiekt detail zawiera "cut_time" oraz "weight"
                var detailRow = "<tr data-program-id='" + programId + "' data-cut-time='" + detail.cut_time + "' data-weight='" + detail.weight + "'>";
                detailRow += "<td><input type='checkbox' class='detailCheckbox' checked></td>";
                if(detail.image_path) {
                  detailRow += "<td><img src='" + detail.image_path + "' alt='Rysunek' style='max-width:100px;'></td>";
                } else {
                  detailRow += "<td></td>";
                }
                detailRow += "<td>" + detail.name + "</td>";
                detailRow += "<td>" + (response.material || "") + "</td>";
                detailRow += "<td>" + (response.thicknes || "") + "</td>";
                detailRow += "<td>" + (detail.dim_x || "") + "</td>";
                detailRow += "<td>" + (detail.dim_y || "") + "</td>";
                // Kolumna "Ilość gięć" z edytowalnym polem
                detailRow += "<td><input type='number' class='bending-input' value='0' style='width:100%; background:inherit; border:none; text-align:center;'/></td>";
                detailRow += "<td>" + formatSecondsToHMS(detail.cut_time) + "</td>";
                detailRow += "<td>" + detail.quantity + "</td>";
                // Początkowe koszty – pobrane z serwera (mogą być przeliczone później)
                detailRow += "<td>" + (detail.cutting_cost || "") + "</td>";
                detailRow += "<td>" + (detail.material_cost || "") + "</td>";
                detailRow += "<td>" + (detail.total_cost || "") + "</td>";
                detailRow += "<td>" + (detail.total_cost_quantity || "") + "</td>";
                detailRow += "</tr>";
                detailsTbody.append(detailRow);
              });
              $("#detailsTable").colResizable({ liveDrag: true });
            },
            error: function(xhr) {
              $("#loading").hide();
              alert("Wystąpił błąd: " + xhr.responseJSON.error);
            }
          });
        });
        $(document).on("click", ".remove-program", function(){
          var programId = $(this).data("program-id");
          $("#programsTableBody tr[data-program-id='" + programId + "']").remove();
          $("#detailsTableBody tr[data-program-id='" + programId + "']").remove();
        });
      });
      // Funkcja wysyłająca nowe wartości konfiguracji do serwera
      function updateConfig() {
        var newConfig = {
          cutting_costs: {
            stal_czarna: parseFloat($("#cuttingCostBlack").val()),
            stal_nierdzewna: parseFloat($("#cuttingCostStainless").val()),
            aluminium: parseFloat($("#cuttingCostAluminium").val())
          },
          material_costs: {
            stal_czarna: parseFloat($("#materialCostBlack").val()),
            stal_nierdzewna: parseFloat($("#materialCostStainless").val()),
            aluminium: parseFloat($("#materialCostAluminium").val())
          },
          suma_kosztow_giecia: parseFloat($("#bendingCostSum").val())
        };
        $.ajax({
          url: '/update_config',
          type: 'POST',
          data: JSON.stringify(newConfig),
          contentType: 'application/json',
          success: function(response) {
            console.log("Konfiguracja zaktualizowana:", response);
          },
          error: function(xhr, status, error) {
            console.error("Błąd przy aktualizacji konfiguracji:", error);
          }
        });
      }

      // Nasłuchiwanie zmian w polach formularza panelu bocznego
      $(document).ready(function() {
        // Istniejący kod...

        // Dodajemy nasłuchiwanie zmian dla wszystkich inputów w formularzu #pricingForm
        $("#pricingForm input").on("change", function() {
          updateConfig();
        });

        // Pozostały istniejący kod w $(document).ready() (np. obsługa sidebaru, upload pliku itd.)
        // ...
      });
      // Funkcja przeliczająca koszt dla pojedynczego wiersza detalu
      function recalcRow($row) {
        // Pobieramy wartość wpisaną przez użytkownika – ilość gięć
        var bendingCount = parseFloat($row.find("input.bending-input").val()) || 0;
        // Pobieramy koszty cięcia i materiału z komórek (kolumna 10 i 11)
        var cuttingCost = parseFloat($row.find("td").eq(10).text()) || 0;
        var materialCost = parseFloat($row.find("td").eq(11).text()) || 0;
        var baseCost = cuttingCost + materialCost;
        // Pobieramy koszt jednego gięcia z panelu bocznego (pole "Suma kosztów gięcia")
        var bendingCost = parseFloat($("#bendingCostSum").val()) || 0;
        // Nowy koszt detalu to koszt podstawowy plus koszt gięć
        var newDetailCost = baseCost + (bendingCount * bendingCost);
        // Aktualizujemy komórkę "Koszt detalu" (kolumna 12)
        $row.find("td").eq(12).text(newDetailCost.toFixed(2));
        // Pobieramy ilość sztuk (kolumna 9)
        var quantity = parseFloat($row.find("td").eq(9).text()) || 1;
        // Aktualizujemy komórkę "Całkowity koszt" (kolumna 13)
        $row.find("td").eq(13).text((newDetailCost * quantity).toFixed(2));
      }

      // Nasłuchiwanie zmian w polach "Ilość gięć" w tabeli detali
      $(document).on("change", ".bending-input", function(){
        var $row = $(this).closest("tr");
        recalcRow($row);
      });

      // Funkcja przeliczająca wszystkie wiersze tabeli detali
      function recalcAllRows() {
        $("#detailsTableBody tr").each(function(){
          recalcRow($(this));
        });
      }

      // Funkcja updateConfig (opisana wcześniej) wysyła nowe wartości z panelu do serwera
      function updateConfig() {
        var newConfig = {
          cutting_costs: {
            stal_czarna: parseFloat($("#cuttingCostBlack").val()),
            stal_nierdzewna: parseFloat($("#cuttingCostStainless").val()),
            aluminium: parseFloat($("#cuttingCostAluminium").val())
          },
          material_costs: {
            stal_czarna: parseFloat($("#materialCostBlack").val()),
            stal_nierdzewna: parseFloat($("#materialCostStainless").val()),
            aluminium: parseFloat($("#materialCostAluminium").val())
          },
          suma_kosztow_giecia: parseFloat($("#bendingCostSum").val())
        };
        $.ajax({
          url: '/update_config',
          type: 'POST',
          data: JSON.stringify(newConfig),
          contentType: 'application/json',
          success: function(response) {
            console.log("Konfiguracja zaktualizowana:", response);
            // Po udanej aktualizacji konfiguracji przeliczamy wszystkie wiersze
            recalcAllRows();
          },
          error: function(xhr, status, error) {
            console.error("Błąd przy aktualizacji konfiguracji:", error);
          }
        });
      }

      // Nasłuchujemy zmian we wszystkich inputach w formularzu panelu cenowego,
      // aby po zmianie wysłać nową konfigurację i przeliczyć koszty w tabeli detali
      $("#pricingForm input").on("change", function() {
        updateConfig();
      });
      // Funkcje zwracające odpowiednie stawki na podstawie materiału (tekst w komórce)
      function getCuttingRate(material) {
        material = material.toLowerCase();
        if (material.indexOf("1.4301") !== -1) {
          return parseFloat($("#cuttingCostStainless").val()) || 0;
        } else if (material.indexOf("1.0038") !== -1 || material.indexOf("st37") !== -1) {
          return parseFloat($("#cuttingCostBlack").val()) || 0;
        } else if (material.indexOf("aluminium") !== -1) {
          return parseFloat($("#cuttingCostAluminium").val()) || 0;
        }
        return parseFloat($("#cuttingCostBlack").val()) || 0;
      }

      function getMaterialRate(material) {
        material = material.toLowerCase();
        if (material.indexOf("1.4301") !== -1) {
          return parseFloat($("#materialCostStainless").val()) || 0;
        } else if (material.indexOf("1.0038") !== -1 || material.indexOf("st37") !== -1) {
          return parseFloat($("#materialCostBlack").val()) || 0;
        } else if (material.indexOf("aluminium") !== -1) {
          return parseFloat($("#materialCostAluminium").val()) || 0;
        }
        return parseFloat($("#materialCostBlack").val()) || 0;
      }

      // Funkcja przeliczająca koszt dla pojedynczego wiersza detalu
      function recalcRow($row) {
        // Pobieramy oryginalne dane: czas cięcia (w minutach) oraz wagę
        var cutTime = parseFloat($row.data("cut-time")) || 0;
        var weight = parseFloat($row.data("weight")) || 0;
        // Pobieramy materiał z komórki (kolumna "Materiał" – indeks 3)
        var material = $row.find("td").eq(3).text();
        // Pobieramy nowe stawki z panelu bocznego
        var newCuttingRate = getCuttingRate(material);
        var newMaterialRate = getMaterialRate(material);
        // Obliczamy nowe koszty:
        var newCuttingCost = cutTime * newCuttingRate;
        var newMaterialCost = weight * newMaterialRate;
        // Obliczamy koszt podstawowy
        var baseCost = newCuttingCost + newMaterialCost;
        // Pobieramy ilość gięć wpisaną przez użytkownika (pole edytowalne w kolumnie "Ilość gięć")
        var bendingCount = parseFloat($row.find("input.bending-input").val()) || 0;
        // Pobieramy koszt jednego gięcia z panelu bocznego
        var bendingCost = parseFloat($("#bendingCostSum").val()) || 0;
        // Nowy koszt detalu to koszt podstawowy + koszt gięć
        var newDetailCost = baseCost + (bendingCount * bendingCost);

        // Aktualizujemy komórki:
        // Kolumna "Koszt cięcia" – indeks 10
        $row.find("td").eq(10).text(newCuttingCost.toFixed(2));
        // Kolumna "Koszt materiału" – indeks 11
        $row.find("td").eq(11).text(newMaterialCost.toFixed(2));
        // Kolumna "Koszt detalu" – indeks 12
        $row.find("td").eq(12).text(newDetailCost.toFixed(2));
        // Pobieramy ilość sztuk (kolumna "Ilość" – indeks 9)
        var quantity = parseFloat($row.find("td").eq(9).text()) || 1;
        // Kolumna "Całkowity koszt" – indeks 13
        $row.find("td").eq(13).text((newDetailCost * quantity).toFixed(2));
      }

      // Funkcja przeliczająca wszystkie wiersze tabeli detali
      function recalcAllRows() {
        $("#detailsTableBody tr").each(function(){
          recalcRow($(this));
        });
      }

      // Funkcja updateConfig wysyła nowe wartości z panelu do serwera i przelicza koszty
      function updateConfig() {
        var newConfig = {
          cutting_costs: {
            stal_czarna: parseFloat($("#cuttingCostBlack").val()),
            stal_nierdzewna: parseFloat($("#cuttingCostStainless").val()),
            aluminium: parseFloat($("#cuttingCostAluminium").val())
          },
          material_costs: {
            stal_czarna: parseFloat($("#materialCostBlack").val()),
            stal_nierdzewna: parseFloat($("#materialCostStainless").val()),
            aluminium: parseFloat($("#materialCostAluminium").val())
          },
          suma_kosztow_giecia: parseFloat($("#bendingCostSum").val())
        };
        $.ajax({
          url: '/update_config',
          type: 'POST',
          data: JSON.stringify(newConfig),
          contentType: 'application/json',
          success: function(response) {
            console.log("Konfiguracja zaktualizowana:", response);
            // Po aktualizacji przeliczamy wszystkie wiersze
            recalcAllRows();
          },
          error: function(xhr, status, error) {
            console.error("Błąd przy aktualizacji konfiguracji:", error);
          }
        });
      }

      // Nasłuchujemy zmian w polach formularza panelu bocznego
      $("#pricingForm input").on("change", function() {
        updateConfig();
      });

      // Nasłuchiwanie zmian w polach "Ilość gięć" w tabeli detali
      $(document).on("change", ".bending-input", function(){
        var $row = $(this).closest("tr");
        recalcRow($row);
      });
    </script>
  </body>
</html>
